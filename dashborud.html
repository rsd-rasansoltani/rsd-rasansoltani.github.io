<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ | Ø±Ø§Ø³Ø§Ù† Ø¯ÛŒØ²Ø§ÛŒÙ†</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
            background-image: radial-gradient(#3b82f6 0.5px, #f3f4f6 0.5px);
            background-size: 10px 10px;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 100;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        #signature-canvas {
            border: 2px dashed #94a3b8;
            border-radius: 1rem;
            cursor: crosshair;
            background-color: #fff;
            width: 100%;
            height: 60vh;
            touch-action: none;
        }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù†ÙˆØ¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú© Ø¯Ø§Ø®Ù„ Ú©Ø§Ø±Øª */
        .node-mini-box {
            font-family: monospace;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 2px;
            height: 35px;
        }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù†ÙˆØ¯Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
        .node-large-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .node-large-box.active {
            border-color: #22c55e;
            background-color: #f0fdf4;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        .node-large-box.inactive {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-20">

    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center glass p-4 rounded-xl sticky top-4 z-40">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-sm md:text-base">Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§Ø³Ø§Ù† Ø¯ÛŒØ²Ø§ÛŒÙ†</h1>
                <p id="user-email" class="text-xs text-gray-500 dir-ltr text-right">Loading...</p>
            </div>
        </div>
        <button id="btn-logout" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm transition font-medium border border-red-200">
            Ø®Ø±ÙˆØ¬
        </button>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <div class="md:col-span-1 space-y-6">
            <div class="glass p-6 rounded-xl border-t-4 border-blue-500">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
                </h2>
                
                <div id="service-selection" class="space-y-2">
                    <p class="text-sm text-gray-500 mb-2">Ø®Ø¯Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
                    <button onclick="selectService('Ø·Ø±Ø§Ø­ÛŒ ÙˆØ¨â€ŒØ³Ø§ÛŒØª')" class="service-btn w-full text-right p-3 rounded-lg bg-white border hover:border-blue-500 hover:bg-blue-50 transition text-sm flex justify-between items-center">
                        <span>ğŸŒ Ø·Ø±Ø§Ø­ÛŒ ÙˆØ¨â€ŒØ³Ø§ÛŒØª</span><span class="text-gray-300">â€º</span>
                    </button>
                    <button onclick="selectService('Ø·Ø±Ø§Ø­ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†')" class="service-btn w-full text-right p-3 rounded-lg bg-white border hover:border-blue-500 hover:bg-blue-50 transition text-sm flex justify-between items-center">
                        <span>ğŸ“± Ø·Ø±Ø§Ø­ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</span><span class="text-gray-300">â€º</span>
                    </button>
                    <button onclick="selectService('Ú©Ø§Ù†ÙÛŒÚ¯ DNS')" class="service-btn w-full text-right p-3 rounded-lg bg-white border hover:border-blue-500 hover:bg-blue-50 transition text-sm flex justify-between items-center">
                        <span>ğŸ® Ú©Ø§Ù†ÙÛŒÚ¯ DNS Ø¨Ø§Ø²ÛŒ</span><span class="text-gray-300">â€º</span>
                    </button>
                </div>

                <div id="project-form" class="hidden mt-4 space-y-3 animate-fade-in">
                    <div class="flex justify-between items-center mb-2 bg-blue-50 p-2 rounded">
                        <span id="selected-service-badge" class="text-blue-800 text-sm font-bold"></span>
                        <button onclick="resetSelection()" class="text-xs text-red-500 hover:text-red-700 bg-white px-2 py-1 rounded border">ØªØºÛŒÛŒØ±</button>
                    </div>
                    
                    <input type="text" id="p-name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" class="w-full p-3 rounded-lg border text-sm bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition">
                    <input type="text" id="p-national" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" class="w-full p-3 rounded-lg border text-sm bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition">
                    <input type="tel" id="p-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="w-full p-3 rounded-lg border text-sm bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition">
                    
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-justify text-gray-600 leading-5">
                        <strong class="text-yellow-700 block mb-1">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯:</strong> 
                        Ø¨Ø¯ÛŒÙ†ÙˆØ³ÛŒÙ„Ù‡ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ú©Ù‡ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµØ­ÛŒØ­ Ø§Ø³Øª. Ù‚ÙˆØ§Ù†ÛŒÙ† Ø´Ø±Ú©Øª Ø±Ø§Ø³Ø§Ù† Ø¯ÛŒØ²Ø§ÛŒÙ† Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù….
                    </div>

                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-gray-50 hover:bg-gray-100 transition cursor-pointer" onclick="openSignatureModal()">
                        <div id="signature-preview-container" class="hidden">
                            <p class="text-xs text-green-600 mb-2 font-bold">âœ… Ø§Ù…Ø¶Ø§ Ø´Ø¯</p>
                            <img id="signature-preview-img" class="h-16 mx-auto object-contain" src="" alt="Ø§Ù…Ø¶Ø§">
                            <p class="text-xs text-gray-400 mt-2">Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                        </div>
                        <div id="signature-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            <span class="text-sm font-bold text-blue-600">Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</span>
                        </div>
                    </div>

                    <button onclick="submitProject()" id="btn-submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg text-sm font-bold shadow-lg shadow-green-500/30 transition transform active:scale-95">
                        ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø±ÙˆÚ˜Ù‡
                    </button>
                </div>
            </div>
        </div>

        <div class="md:col-span-2">
            <div class="glass p-6 rounded-xl min-h-[500px]">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†
                </h2>

                <div id="projects-container" class="space-y-4">
                    <div class="text-center text-gray-400 mt-10">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="signature-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-0 md:p-4 backdrop-blur-sm">
        <div class="bg-white w-full h-full md:h-auto md:max-w-2xl rounded-none md:rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-700">âœï¸ Ù…Ø­Ù„ Ø§Ù…Ø¶Ø§</h3>
                <button onclick="closeSignatureModal()" class="text-gray-500 hover:text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-1 p-4 bg-gray-50 flex items-center justify-center relative">
                <canvas id="signature-canvas"></canvas>
                <div class="absolute bottom-6 text-gray-300 pointer-events-none text-sm select-none">Ø¯Ø± Ú©Ø§Ø¯Ø± Ø¨Ø§Ù„Ø§ Ø§Ù…Ø¶Ø§ Ú©Ù†ÛŒØ¯</div>
            </div>
            <div class="p-4 bg-white border-t flex justify-between gap-3">
                <button onclick="clearSignature()" class="px-4 py-2 text-red-600 border border-red-200 rounded-lg hover:bg-red-50 text-sm font-medium">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                <button onclick="saveSignature()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg text-sm font-bold shadow-lg hover:bg-blue-700 transition">ØªØ§ÛŒÛŒØ¯ Ø§Ù…Ø¶Ø§</button>
            </div>
        </div>
    </div>

    <div id="node-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90 p-4 backdrop-blur-sm">
        <div class="bg-gray-50 w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-l from-indigo-600 to-blue-600 p-4 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>
                    <h3 class="font-bold text-lg">ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ (Nodes)</h3>
                </div>
                <button onclick="closeNodeModal()" class="hover:bg-white/20 p-1 rounded-full transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div id="node-modal-grid" class="grid grid-cols-1 gap-4"> 
                    </div>
            </div>

            <div class="bg-white p-4 border-t text-center shrink-0">
                <button onclick="closeNodeModal()" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg text-sm font-bold transition">Ø¨Ø³ØªÙ† ØµÙØ­Ù‡</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-gradient-to-l from-blue-600 to-purple-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">ğŸ“¢ Ù¾ÛŒØ§Ù… Ù…Ø¯ÛŒØ±ÛŒØª</h3>
                <button onclick="closeAdminModal()" class="hover:bg-white/20 p-1 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-6">
                <div id="modal-content" class="space-y-4"></div>
            </div>
            <div class="bg-gray-50 p-4 text-left">
                <button onclick="closeAdminModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Ú©Ø§Ù†ÙÛŒÚ¯ ÙØ§ÛŒØ±Ø¨ÛŒØ³ (Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø®ÙˆØ¯ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯)
        const firebaseConfig = {
            apiKey: "AIzaSyD_Zyp4-it4jqoDDKoHQYkJZcW6wpgzNIw",
            authDomain: "rasandesign-c13b0.firebaseapp.com",
            projectId: "rasandesign-c13b0",
            storageBucket: "rasandesign-c13b0.appspot.com",
            messagingSenderId: "704936216056",
            appId: "1:704936216056:web:94050563c2f1320e6bc20d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ğŸŒŸğŸŒŸğŸŒŸ ØªØ¹Ø±ÛŒÙ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: R1 ØªØ§ R20 ğŸŒŸğŸŒŸğŸŒŸ
        const DEFAULT_NODE_KEYS = [
            'R1', 'R2', 'R3', 'R4', 'R5', 'R6', 'R7', 'R8', 'R9', 'R10', 
            'R11', 'R12', 'R13', 'R14', 'R15', 'R16', 'R17', 'R18', 'R19', 'R20'
        ];

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„
        let signaturePad;
        let currentUser = null;
        let savedSignatureData = null;

        window.addEventListener('load', () => {
            const canvas = document.getElementById('signature-canvas');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 3
            });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').innerText = user.email;
                loadUserProjects(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'login.html');
        });

        // ---------------------------------------------
        // ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…ÙˆØ¯Ø§Ù„ Ø³Ø±ÙˆØ±Ù‡Ø§ (Ù†ÙˆØ¯Ù‡Ø§)
        // ---------------------------------------------
        window.openNodeModal = (encodedNodes) => {
            const nodes = JSON.parse(decodeURIComponent(encodedNodes));
            const grid = document.getElementById('node-modal-grid');
            grid.innerHTML = '';

            const nodeKeys = Object.keys(nodes).sort(); 

            nodeKeys.forEach(key => {
                // Ø§Ú¯Ø± Ù†ÙˆØ¯ÛŒ Ù…Ù‚Ø¯Ø§Ø± Ù†Ø¯Ø§Ø´ØªØŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 20 Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                const value = nodes[key] || "20"; 
                
                let statusClass = "border-gray-200";
                let icon = `<div class="w-3 h-3 bg-gray-300 rounded-full"></div>`;
                let textClass = "text-gray-500";
                let description = "Ù†Ø§Ù…Ø´Ø®Øµ"; 

                if(value === "ÙØ¹Ø§Ù„" || value === "ON") {
                    statusClass = "active";
                    textClass = "text-green-600 font-bold";
                    icon = `<div class="w-3 h-3 bg-green-500 rounded-full shadow-[0_0_8px_rgba(34,197,94,0.6)] animate-pulse"></div>`;
                    description = "ÙØ¹Ø§Ù„ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø±ÙˆÛŒØ³â€ŒØ¯Ù‡ÛŒ";
                } else if (value === "Ù‚Ø·Ø¹" || value === "OFF") {
                    statusClass = "inactive";
                    textClass = "text-red-600 font-bold";
                    icon = `<div class="w-3 h-3 bg-red-500 rounded-full"></div>`;
                    description = "Ø³Ø±ÙˆÛŒØ³ Ù‚Ø·Ø¹ ÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª";
                } else if (value === "20") { // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø­Ø§Ù„Øª Ø®Ù†Ø«ÛŒ
                    statusClass = "border-gray-300";
                    textClass = "text-gray-600 font-bold";
                    icon = `<div class="w-3 h-3 bg-yellow-400 rounded-full"></div>`;
                    description = "RS";
                } 

                const div = document.createElement('div');
                div.className = `node-large-box ${statusClass}`;
                div.innerHTML = `
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-4">
                        ${icon}
                        <div class="text-lg font-bold text-gray-800">${key}</div> 
                        <p class="text-xs text-gray-500">ÙˆØ¶Ø¹ÛŒØª: ${description}</p>
                    </div>
                    <span class="text-xl font-mono ${textClass} mt-2 md:mt-0 ml-auto">${value}</span>
                `;
                grid.appendChild(div);
            });

            const modal = document.getElementById('node-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('visible'), 10);
        };

        window.closeNodeModal = () => {
            const modal = document.getElementById('node-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        // ---------------------------------------------
        // ØªÙˆØ§Ø¨Ø¹ Ø§Ù…Ø¶Ø§
        // ---------------------------------------------
        window.openSignatureModal = () => {
            const modal = document.getElementById('signature-modal');
            const canvas = document.getElementById('signature-canvas');
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('visible'), 10);
            
            setTimeout(() => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear(); 
            }, 100);
        };

        window.closeSignatureModal = () => {
            const modal = document.getElementById('signature-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        window.clearSignature = () => signaturePad.clear();

        window.saveSignature = () => {
            if (signaturePad.isEmpty()) {
                alert("Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø¯Ø± Ø±Ø§ Ø§Ù…Ø¶Ø§ Ú©Ù†ÛŒØ¯.");
                return;
            }
            savedSignatureData = signaturePad.toDataURL();
            document.getElementById('signature-placeholder').classList.add('hidden');
            document.getElementById('signature-preview-container').classList.remove('hidden');
            document.getElementById('signature-preview-img').src = savedSignatureData;
            closeSignatureModal();
        };

        // --- ØªÙˆØ§Ø¨Ø¹ ÙØ±Ù… ---
        window.selectService = (serviceName) => {
            document.getElementById('service-selection').classList.add('hidden');
            document.getElementById('project-form').classList.remove('hidden');
            document.getElementById('selected-service-badge').innerText = serviceName;
            document.getElementById('project-form').dataset.service = serviceName;
        };

        window.resetSelection = () => {
            document.getElementById('project-form').classList.add('hidden');
            document.getElementById('service-selection').classList.remove('hidden');
            savedSignatureData = null;
            document.getElementById('signature-preview-container').classList.add('hidden');
            document.getElementById('signature-placeholder').classList.remove('hidden');
        };

        // --- Ø§Ø±Ø³Ø§Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ ---
        window.submitProject = async () => {
            const btn = document.getElementById('btn-submit');
            const name = document.getElementById('p-name').value;
            const national = document.getElementById('p-national').value;
            const phone = document.getElementById('p-phone').value;
            const service = document.getElementById('project-form').dataset.service;

            if (!name || !national || !phone) {
                alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            if (!savedSignatureData) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø±Ø§ Ø§Ù…Ø¶Ø§ Ú©Ù†ÛŒØ¯.');
                openSignatureModal();
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

            try {
                const defaultNodes = {};
                // ØªØ¹Ø±ÛŒÙ Ù†ÙˆØ¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± '20' (R1 ØªØ§ R20)
                DEFAULT_NODE_KEYS.forEach(key => {
                    defaultNodes[key] = "20"; 
                });

                await addDoc(collection(db, "projects"), {
                    userId: currentUser.uid,
                    email: currentUser.email,
                    firstName: name,
                    lastName: "", 
                    fullName: name,
                    nationalCode: national,
                    phoneNumber: phone,
                    service: service,
                    signature: savedSignatureData,
                    status: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ',
                    nodeStatus: defaultNodes,
                    createdAt: serverTimestamp(),
                    adminResponse: null 
                });

                sendToTelegram(service, name, phone, currentUser.email);

                alert('âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.');
                resetSelection();
                document.getElementById('p-name').value = '';
                document.getElementById('p-national').value = '';
                document.getElementById('p-phone').value = '';
                
            } catch (error) {
                console.error("Error adding document: ", error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø±ÙˆÚ˜Ù‡';
            }
        };

        function sendToTelegram(service, name, phone, email) {
            const botToken = "7851763243:AAEKxm55yC3PelOQKsDl3tD_LRVkbzN1ggk";
            const chatId = "7650517255";
            const message = `ğŸš€ *Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯*\nğŸ‘¤ Ù†Ø§Ù…: ${name}\nğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: ${email}\nğŸ“± ØªÙ„ÙÙ†: ${phone}\nğŸ›  Ø³Ø±ÙˆÛŒØ³: ${service}`;
            
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: "Markdown" })
            }).catch(console.error);
        }

        // --- Ù†Ù…Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ (Real-time) ---
        function loadUserProjects(userId) {
            const q = query(collection(db, "projects"), where("userId", "==", userId));
            
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('projects-container');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-10 bg-gray-50 rounded-lg">Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</div>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const projectId = doc.id;
                    const hasAdminResponse = data.adminResponse && data.adminResponse.message;
                    
                    let statusColor = 'bg-yellow-100 text-yellow-800';
                    if (data.status === 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡' || data.status === 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯') statusColor = 'bg-green-100 text-green-800';
                    if (data.status === 'Ø±Ø¯ Ø´Ø¯Ù‡') statusColor = 'bg-red-100 text-red-800';

                    // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§ÛŒ Ù†ÙˆØ¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„
                    const nodes = data.nodeStatus || {};
                    const nodesEncoded = encodeURIComponent(JSON.stringify(nodes));

                    // Ø³Ø§Ø®ØªÙ† HTML Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú© (Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´)
                    let miniNodesHtml = '';
                    const nodeKeys = Object.keys(nodes).sort(); 
                    
                    // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ÛŒÙ†Ù‡ Ø¯Ø± Ú©Ø§Ø±Øª Ú©ÙˆÚ†Ú©ØŒ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ Û±Û° ØªØ§ Ù…Ø­Ø¯ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    const displayKeys = nodeKeys.slice(0, 10); 

                    displayKeys.forEach(key => {
                        const value = nodes[key] || "20";
                        let displayValue = value;
                        let bgClass = "";

                        if(value === "ÙØ¹Ø§Ù„" || value === "ON") bgClass = "bg-green-50 border-green-200 text-green-700";
                        else if(value === "Ù‚Ø·Ø¹" || value === "OFF") bgClass = "bg-red-50 border-red-200 text-red-700";
                        else if (value === "-----") displayValue = "-"; // Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ 

                        miniNodesHtml += `
                            <div class="node-mini-box ${bgClass}">
                                <span class="text-gray-400 text-[8px] truncate max-w-full">${key}</span>
                                <span class="font-bold">${displayValue}</span>
                            </div>
                        `;
                    });

                    const card = document.createElement('div');
                    card.className = "bg-white border border-gray-100 rounded-lg p-5 shadow-sm hover:shadow-md transition relative overflow-hidden";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3 border-b pb-3">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${data.service || 'Ø³Ø±ÙˆÛŒØ³ Ù†Ø§Ù…Ø´Ø®Øµ'}</h3>
                                <p class="text-xs text-gray-400 mt-1 font-mono">ID: ${projectId.substr(0, 8)}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full font-bold ${statusColor}">${data.status || 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±'}</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400">Ù†Ø§Ù…:</span>
                                <span class="font-medium text-gray-800">${data.fullName}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400">Ø§ÛŒÙ…ÛŒÙ„:</span>
                                <span class="font-medium text-gray-800 dir-ltr text-right truncate">${data.email || currentUser.email}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400">ØªØ§Ø±ÛŒØ®:</span>
                                <span class="font-medium text-gray-800">${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString('fa-IR') : '...'}</span>
                            </div>
                        </div>
                        
                        <div onclick="openNodeModal('${nodesEncoded}')" class="bg-blue-50 hover:bg-blue-100 rounded-lg p-3 mb-3 border border-blue-100 cursor-pointer transition group">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-bold text-blue-800">ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ (Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø²Ø±Ú¯ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 group-hover:translate-x-1 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </div>
                            <div class="grid grid-cols-5 md:grid-cols-10 gap-1 md:gap-2">
                                ${miniNodesHtml}
                                ${nodeKeys.length > 10 ? '<div class="node-mini-box bg-gray-100 border-gray-300 text-gray-500"><span class="font-bold text-xs">...</span></div>' : ''}
                            </div>
                        </div>

                        ${hasAdminResponse ? `
                            <button onclick="window.showAdminMessage('${projectId}')" class="w-full mt-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-sm py-2 rounded-lg shadow-lg flex items-center justify-center gap-2 animate-pulse-slow">
                                Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø§Ø³Ø® Ù…Ø¯ÛŒØ±ÛŒØª
                            </button>
                        ` : ''}
                    `;
                    
                    if(hasAdminResponse) {
                        card.dataset.adminMsg = JSON.stringify(data.adminResponse);
                    }

                    container.appendChild(card);
                });
            });
        }

        window.showAdminMessage = (projectId) => {
            const cards = document.querySelectorAll('#projects-container > div');
            let foundData = null;
            cards.forEach(card => {
                if (card.innerHTML.includes(projectId.substr(0, 8)) && card.dataset.adminMsg) {
                    foundData = JSON.parse(card.dataset.adminMsg);
                }
            });

            if (foundData) {
                const content = document.getElementById('modal-content');
                let html = `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h4 class="font-bold text-blue-800 mb-2">Ù¾ÛŒØ§Ù…:</h4>
                        <p class="text-gray-700 text-sm leading-6">${foundData.message}</p>
                    </div>
                `;
                if (foundData.token) {
                    html += `
                        <div class="mt-4">
                            <label class="text-xs text-gray-500 font-bold block mb-1">ØªÙˆÚ©Ù† / Ù„Ø§ÛŒØ³Ù†Ø³:</label>
                            <div class="flex items-center gap-2 bg-gray-100 p-2 rounded border border-gray-300">
                                <code class="text-sm font-mono text-red-600 flex-1 select-all">${foundData.token}</code>
                            </div>
                        </div>
                    `;
                }
                content.innerHTML = html;
                const modal = document.getElementById('admin-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('visible'), 10);
            }
        };

        window.closeAdminModal = () => {
            const modal = document.getElementById('admin-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
    </script>
</body>
</html>
